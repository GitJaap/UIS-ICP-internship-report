%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Stylish Article
% LaTeX Template
% Version 2.1 (1/10/15)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% Mathias Legrand (legrand.mathias@gmail.com) 
% With extensive modifications by:
% Vel (vel@latextemplates.com)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[fleqn,11pt]{SelfArx} % Document font size and equations flushed left
\usepackage[scaled]{helvet}
\renewcommand\familydefault{\sfdefault} 
\usepackage[T1]{fontenc}

\usepackage[english]{babel} % Specify a different language here - english by default

\usepackage{lipsum} % Required to insert dummy text. To be removed otherwise

\usepackage{amsmath}
\DeclareMathOperator{\Var}{Var}

\newcommand{\pder}[2][]{\frac{\partial#1}{\partial#2}}
\newcommand{\ppder}[2][]{\frac{\partial^2#1}{\partial#2^2}}
\usepackage{amsthm}
\usepackage[nice]{nicefrac}
\theoremstyle{definition}
\newtheorem{exmp}{Example}[section]


%------------------------
%   EXAMPLE USES OF STYLES
%--------------

%\begin{figure*}[ht]\centering % Using \begin{figure*} makes the figure take up the entire width of the page
%\includegraphics[width=\linewidth]{view}
%\caption{Wide Picture}
%\label{fig:view}
%\end{figure*}


%\begin{enumerate}[noitemsep] % [noitemsep] removes whitespace between the items for a compact look
%\item First item in a list
%\item Second item in a list
%\item Third item in a list
%\end{enumerate}



%\paragraph{Paragraph} \lipsum[7] % Dummy text
%\paragraph{Paragraph} \lipsum[8] % Dummy text


%\begin{table}[hbt]
%\caption{Table of Grades}
%\centering
%\begin{tabular}{llr}
%\toprule
%\multicolumn{2}{c}{Name} \\
%\cmidrule(r){1-2}
%First name & Last Name & Grade \\
%\midrule
%John & Doe & $7.5$ \\
%Richard & Miles & $2$ \\
%\bottomrule
%\end{tabular}
%\label{tab:label}
%\end{table}

%\begin{description}
%\item[Word] Definition
%\item[Concept] Explanation
%\item[Idea] Text
%\end{description}


%\begin{itemize}[noitemsep] % [noitemsep] removes whitespace between the items for a compact look
%\item First item in a list
%\item Second item in a list
%\item Third item in a list
%\end{itemize}




%----------------------------------------------------------------------------------------
%	COLUMNS
%----------------------------------------------------------------------------------------

\setlength{\columnsep}{0.55cm} % Distance between the two columns of text
\setlength{\fboxrule}{0.75pt} % Width of the border around the abstract

%----------------------------------------------------------------------------------------
%	COLORS
%----------------------------------------------------------------------------------------

\definecolor{color1}{RGB}{0,0,90} % Color of the article title and sections
\definecolor{color2}{RGB}{0,20,20} % Color of the boxes behind the abstract and headings

%----------------------------------------------------------------------------------------
%	HYPERLINKS
%----------------------------------------------------------------------------------------

\usepackage{hyperref} % Required for hyperlinks
\hypersetup{hidelinks,colorlinks,breaklinks=true,urlcolor=color2,citecolor=color1,linkcolor=color1,bookmarksopen=false,pdftitle={Title},pdfauthor={Author}}
\usepackage[capitalise]{cleveref}

\crefname{exmp}{example}{examples}
\Crefname{exmp}{Example}{Examples}
%----------------------------------------------------------------------------------------
%	ARTICLE INFORMATION
%----------------------------------------------------------------------------------------

\JournalInfo{Internship report for the Instituto Colombia del Petróleo (ICP)} % Journal information
\Archive{In requirement of the degree Master of science Applied Physics, TU Delft, the Netherlands} % Additional notes (e.g. copyright, DOI, review/research article)

\PaperTitle{Full waveform inversion of isotropic elastic media using an adjoint state method in finite difference time-domain} % Article title
\PageHeading{ICP - CPS}

\Authors{J. J. Wesdorp*} % Authors

\Keywords{ Herling Gonzalez-Alvarez \textsuperscript{1} \newline Prof. Koen van Dongen \textsuperscript{2} \newline Prof. Ana Ramirez \textsuperscript{3}} % Keywords - if you don't want any simply remove all the text between the curly brackets
\newcommand{\keywordname}{Supervisors} % Defines the keywords heading name
\affiliation{\textsuperscript{1}\textit{Instituto Colombia del Petróleo (ICP), Piedecuesta, Colombia}} % Author affiliation
\affiliation{\textsuperscript{2}\textit{Technical University of Delft, the Netherlands}} % Author affiliation
\affiliation{\textsuperscript{3}\textit{Universidad Industrial de Santander (UIS), CPS research group, Bucaramanga, Colombia}}
\affiliation{*\textbf{email}: jaapwesdorp@gmail.com} % Corresponding author
%----------------------------------------------------------------------------------------
%	ABSTRACT
%----------------------------------------------------------------------------------------

\Abstract{\lipsum[1]~}

%----------------------------------------------------------------------------------------

\begin{document}

\flushbottom % Makes all text pages the same height

\maketitle % Print the title and abstract box

\onecolumn

\tableofcontents % Print the contents section

\thispagestyle{empty} % Removes page numbering from the first page
%----------------------------------------------------------------------------------------
%	ARTICLE CONTENTS
%----------------------------------------------------------------------------------------

\section{Introduction} % The \section*{} command stops section numbering
Full waveform inversion can be used a tool to quantitatively image material properties of the earth, or tissue. 

30 years ago -> ~\cite{Tarantola1986} proposed FWI. Now since 10 years the industry is making use of FWI in their processing workflow due to the gain in computing power.

Initially mostly acoustic, but there is interest in modeling elastic waves, since you can see phenomena like: groundroll waves, surface waves ->(WHAT ELSE IS SPECIAL ABOUT ELASTIC). 

FWI requires one to know the gradient of your guessed model with respect to measured shots, therefore the \emph{adjoint state method}~\cite{Plessix2006} makes this a lot more efficient. 

This research was performed as part of an internship for the Instituto Colombia del Petróleo (ICP). The first goal was to model the isotropic 2D elastic wave equation, which is described in section ...
The second goal was to find the adjoint operator and gradients for the elastic case. Since no explicit declaration is given yet for the elastic case in current literature and the adjoint state method is usually described in a very abstract way, this work shows an "engineers approach" to obtaining the adjoint system and gradient expressions for any general set of equations in sec .... This method is applied to the elastic case in sec ..., and more exampĺes are given in~\cref{sec:examples}.
This method is subsequently tested by performing FWI on a test model described in sec ...



%\addcontentsline{toc}{section}{Introduction} % Adds this section to the table of contents

%-------------------------------------------------------------------------------------------------------------------

\section{A simple recipe for the adjoint state method}


\subsection{Adjoint method for general discretized linear systems}\label{sec:discretized_math}
This section shows in simple steps how to obtain the adjoint equations and gradients given a general system of wave equations and initial and boundary conditions of zero. These are cast in a general form usually present in acoustic, elastic or electromagnetic FWI applications. The proof of validity and derivation of this method is presented in \cref{sec:general_math} for an more general set of equations based on the notes of Bradley\cite{Bradley2012}.
\subsubsection{Formulation}{}
Say we have a model representing the earth (in seismic applications) or tissue (in medical applications) for some parameter like density $\rho$ or speed of sound $v$, which we discretized in a grid in space into $N_g  (= N_x \times N_z$ in 2D) points. If we want to model $d_m$ parameters over this grid we can write the values of these parameters over the grid as a vector $\vec{m}$ of dimension $d_m \times N_g$. We want to model $d_s$ fields also discretized in space on the same grid we can write them as a vector $\vec{s}$ of dimension $d_s \times N_g$. Any FWI problem of wave equations(e.g electromagnetic, elastic or acoustic), whether they are  multiple first or second order PDE's in time and space, can be written as the following minimization problem given a set of discretized(only in space) ODEs
\begin{equation}
\label{eq:discretised_linear_system}
\begin{aligned}
\underset{\vec{m}}{\text{min}}\  & \chi\left(\vec{s},\vec{m}\right) =   \int_0^T f\left(\vec{s},\vec{m}\right) dt \\
\text{subject to}\ \ \   &   T\left(\vec{m}\right)\ddot{\vec{s}} - C\left(\vec{m}\right)\dot{\vec{s}} - A\left(\vec{m}\right)\vec{s} -\vec{b}\left(\vec{m}\right)= 0 \\
 \text{with B.C}\ \ \  &  \vec{s}\left(0\right)  = 0 \\
 &  \dot{\vec{s}}\left(0\right)  = 0 \\
\end{aligned}
\end{equation}
where $T, C, A$ are big matrices of $(N_g \times d_s) \times (N_g \times d_s)$ coefficients which follow from the discretization in space of a PDE system, $\vec{b}\left(\vec{m}\right)$ is a vector of the same length of $\vec{s}$ which contains the source terms, $\chi$ denotes the total cost function and we denote time explicitely by taking the integral of some function $f$ since usually we simplify each cost function into this form. 

\subsubsection{Gradients and adjoint}
We can apply~\cref{eq:general_gradient} of~\cref{sec:general_math} to the system of~\cref{eq:discretised_linear_system} and find the following expression for the total gradient with respect to \emph{all} model parameters
\begin{equation}\label{eq:gradient_discretised_linear}
\frac{d\chi}{d\vec{m}} = \int_0^T \pder[f]{\vec{m}} + \vec{\lambda}^T \left(\pder[T]{\vec{m}}\ddot{\vec{s}} - \pder[C]{\vec{m}}\dot{\vec{s}} - \pder[A]{\vec{m}}\vec{s} -\pder[b]{\vec{m}}\right) dt
\end{equation}
Note that the gradients $\pder[T]{\vec{m}}, \pder[C]{\vec{m}}, \pder[A]{\vec{m}}$ can be seen as a sum of all the $3N$ derivatives of each component of the matrices $T\left(\vec{m}\right), C\left(\vec{m}\right), A\left(\vec{m}\right)$ to the discrete variables $\vec{m}_i$, but in practice we can write this into simple compact expressions as shown in the examples in~\cref{sec:examples}.
The adjoint variable $\lambda$ is given using~\cref{eq:general_adjoint} and applying it to our system of~\cref{eq:discretised_linear_system} we obtain
\begin{equation}\label{eq:adjoint_discretised_linear}
T^T\left(\vec{m}\right) \ddot{\vec{\lambda}} = -C^T\left(\vec{m}\right)\dot{\vec{\lambda}} + A^T\left(\vec{m}\right) \vec{\lambda} - \pder[f]{\vec{s}}
\end{equation}
giving an extra set of equations that need to be solved. 


\subsubsection{Least squares cost function}
In most cases the cost function is given by the misfit between observed data $d$ at certain receiver positions $y_R$ and the modeled data at the same positions $s_{y_R}$, so $f\left(\vec{s}\right)$ is given by 
\begin{equation}\label{eq:cost_function_standard}
f\left(\vec{s}\right) =\frac{1}{2} \sum_{R}^{N_R}||s_{y_R} - d_{y_R}||^2
\end{equation}
where the sum goes over all receiver positions. Note that $f\left(\vec{s}\right)$ does not depend directly on the model parameters $\vec{m}$ making the gradient expression simpler since $\pder[f]{\vec{m}} = 0$. We thus obtain
\begin{equation}
\pder[f]{\vec{s}} =  \sum_{R}^{N_R}||s_{y_R} - d_{y_R}|| 
\end{equation}


\subsection{Adjoint and gradients of the elastic wave equation}
Elastic waves in 2D isotropic media can be modeled by using only three parameters, the density $\rho$ and the two Lame parameters $\mu, \lambda$ and follow the following system of equations
\begin{equation}\label{eq:elastic_system}
\begin{aligned}
\rho \pder[v_x]{t} = \pder[\tau_{xx}]{x} + \pder[\tau_{xz}]{z} \\
\rho \pder[v_z]{t} = \pder[\tau_{xz}]{x} + \pder[\tau_{zz}]{z} \\
\pder[\tau_{xx}]{t} = \left(\lambda + 2\mu\right) \pder[v_x]{x} + \lambda \pder[v_z]{z} + b_{xx} \\
\pder[\tau_{zz}]{t} = \left(\lambda + 2\mu\right) \pder[v_z]{z} + \lambda \pder[v_x]{x} + b_{zz} \\
\pder[\tau_{xz}]{t} = \mu\left( \pder[v_x]{z} + \pder[v_z]{x}\right) \\
\end{aligned}
\end{equation} 
where we only added the source to the stress as to resemble an earthquake. The form of $b$ is independent of the model parameters and usually taken as a ricker wavelet. 
writing this in the form of~\cref{eq:discretised_linear_system} gives 
\begin{equation}
T(m) = 0,\ 
s = 
\begin{bmatrix}
v_x \\
v_z \\
\tau_{xx}\\
\tau_{zz} \\
\tau_{xz} \\
\end{bmatrix},\ C\left(m\right) = -
\begin{bmatrix}
\vec \rho & 0 & 0 & 0 & 0 \\
0 & \vec \rho & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 1 \\
\end{bmatrix}
\end{equation}
and 
\begin{equation}
A\left(m\right) = 
\begin{bmatrix}
0 & 0 & \mathcal{D}_x & 0 & \mathcal{D}_z \\
0 & 0 & 0 & \mathcal{D}_z & \mathcal{D}_x \\
\left(\lambda + 2\mu\right)\mathcal{D}_x & \lambda \mathcal{D}_z & 0 & 0 & 0 \\
\lambda \mathcal{D}_x & \left(\lambda + 2\mu\right) \mathcal{D}_z & 0 & 0 & 0 \\
\mu \mathcal{D}_z & \mu \mathcal{D}_x & 0 & 0 & 0 \\
\end{bmatrix}
\end{equation}
Thus we have $C^T\left(m\right) = C\left(m\right)$ and 
\begin{equation}
A^T\left(m\right) = 
\begin{bmatrix}
0 & 0 & -\mathcal{D}_x\left(\lambda + 2\mu\right) & -\mathcal{D}_x\lambda & -\mathcal{D}_z\mu \\
0 & 0 & -\mathcal{D}_z \lambda & -\mathcal{D}_z\left(\lambda + 2\mu\right) & -\mathcal{D}_x\mu \\
-\mathcal{D}_x & 0 & 0 & 0 & 0 \\
0 & -\mathcal{D}_z & 0 & 0 & 0 \\
-\mathcal{D}_z & -\mathcal{D}_x & 0 & 0 & 0 \\
\end{bmatrix}
\end{equation}
which in turn (when transforming back to the continuous domain from the discrete variables) results in the following adjoint equations(naming the adjoint variable $l$) as defined in~\cref{eq:adjoint_discretised_linear}
\begin{equation}\label{eq:elastic_adjoint}
\begin{aligned}
\rho \pder[l_1]{t} &= \pder[\left(\left(\lambda + 2\mu\right)l_3\right)]{x} + \pder[\left(\lambda l_4\right)]{x} + \pder[\left(\mu \lambda_5\right)]{z} \\
\rho \pder[l_2]{t} &= \pder[\left(\lambda l_3\right)]{z} + \pder[\left(\left(\lambda + 2\mu\right)l_4\right)]{z} + \pder[\left(\mu \lambda_5\right)]{x} \\
\pder[l_3]{t} &= \pder[l_1]{x}\\
\pder[l_4]{t} &= \pder[l_2]{z}\\
\pder[l_5]{t} &= \pder[l_1]{z} + \pder[l_2]{x}\\
\end{aligned}
\end{equation}
where the order of differentiation and multiplication with the model parameters is important. 
The gradients then follow from~\cref{eq:gradient_discretised_linear}, giving 

\begin{equation}
\begin{aligned}
\frac{d\chi}{d\rho} &= \int_0^T - l^T \pder[C]{\rho} \dot s\ dt \\
&=\int_0^T
 \begin{bmatrix}
\vec{l_1}&\vec{l_2}&\vec{l_3} &\vec{l_4} & \vec{l_5}\\
\end{bmatrix}
 \begin{bmatrix}
I & 0 & 0 & 0 & 0 \\
0  & I & 0&0&0\\
0 & 0 & 0&0&0\\
0&0&0&0&0\\
0&0&0&0&0
\end{bmatrix}
\begin{bmatrix}
\vec{\dot{v_x}}\\
\vec{\dot{v_y}}\\
\vec{\dot{\tau_{xx}}}\\
\vec{\dot{\tau_{zz}}}\\
\vec{\dot{\tau_{xz}}}
\end{bmatrix} \\
&=\int_0^T \vec{l_1}\vec{\dot{v}}_x + \vec{l_2}\vec{\dot{v}}_z \ dt 
\end{aligned}
\end{equation},

\begin{equation}
\begin{aligned}
\frac{d\chi}{d\lambda} &= \int_0^T - l^T \pder[A]{\lambda} s\ dt \\
&=-\int_0^T
 \begin{bmatrix}
\vec{l_1}&\vec{l_2}&\vec{l_3} &\vec{l_4} & \vec{l_5}\\
\end{bmatrix}
 \begin{bmatrix}
0 & 0 & 0 & 0 & 0 \\
0  & 0 & 0&0&0\\
\mathcal{D}_x & \mathcal{D}_z & 0&0&0\\
\mathcal{D}_x&\mathcal{D}_z&0&0&0\\
0&0&0&0&0
\end{bmatrix}
\begin{bmatrix}
\vec{{v_x}}\\
\vec{{v_y}}\\
\vec{{\tau_{xx}}}\\
\vec{{\tau_{zz}}}\\
\vec{{\tau_{xz}}}
\end{bmatrix} \\
&=-\int_0^T \left(\vec{l_3} + \vec{l_4}\right) \left(\pder[\vec{v_x}]{x} + \pder[\vec{v_z}]{z}\right) 
\end{aligned}
\end{equation} and

\begin{equation}
\begin{aligned}
\frac{d\chi}{d\mu} &= \int_0^T - l^T \pder[A]{\mu} s\ dt \\
&=-\int_0^T
 \begin{bmatrix}
\vec{l_1}&\vec{l_2}&\vec{l_3} &\vec{l_4} & \vec{l_5}\\
\end{bmatrix}
 \begin{bmatrix}
0 & 0 & 0 & 0 & 0 \\
0  & 0 & 0&0&0\\
2\mathcal{D}_x & 0 & 0&0&0\\
0 &2\mathcal{D}_z&0&0&0\\
\mathcal{D}_z&\mathcal{D}_x&0&0&0
\end{bmatrix}
\begin{bmatrix}
\vec{{v_x}}\\
\vec{{v_y}}\\
\vec{{\tau_{xx}}}\\
\vec{{\tau_{zz}}}\\
\vec{{\tau_{xz}}}
\end{bmatrix} \\{}
&=-\int_0^T 2\vec{l_3} \pder[\vec{v_x}]{x} + 2\vec{l_4} \pder[\vec{v_z}]{z} + \vec{l_5}\left(\pder[\vec{v_x}]{z} + \pder[\vec{v_z}]{x}\right) \ dt
\end{aligned}
\end{equation}

%-------------------------------------------------------------------------------------------------------------------

\section{Numerical implementation}
Chapter intro here

\subsection{Staggered grid discrete equations}
We now show the modeling of~\cref{eq:elastic_system}.
Due to the nature of the equations, if we would implement every field at the same grid point in time and space using centered finite differences, we would get decoupling between the velocity and stress in time and space(e.g $V_x$ at time t depending on $\tau$ at time $t \pm \frac{dt}{2}$ which we do not have defined).
This could be solved by using a two times finer grid, but can be more elegantly solved by use a staggered grid following~\cite{Virieux1984}.
Using the notation $\left\{v_x, v_z, \tau_{xx}, \tau_{zz}, \tau_{xz}\right\} = \left\{U, V, X, Z, T \right\}$ we do a "leapfrog" scheme, which in each timestep loops over the spatial directions for calculating $U^{n+\frac{1}{2}},V^{n+\frac{1}{2}}$ as a function of the previously calculated $X^n, Z^n, T^n$ first and consecutively loops over the spatial directions again to calculate $X^{n+1}, Z^{n+1}, T^{n+1}$ depending on the just calculated $U^{n+\frac{1}{2}},V^{n+\frac{1}{2}}$. 
This avoids the decoupling mentioned above, but requires the fields to be defined in different points in the grid.
The numerical equations are then given by (using a 2nd order central difference in time and arbitrary difference operator in space)

\begin{equation}
\left\{
\begin{split}
U_{i,j}^{n+\frac{1}{2}}  &= U_{i,j}^{n-\frac{1}{2}} + \frac{\Delta t}{\rho_{i,j}}\left[ D_xX_{i,j}^n + D_zT^n_{i,j}\right] \\
V_{i+\frac{1}{2},j+\frac{1}{2}}^{n+\frac{1}{2}}  &= V_{i+\frac{1}{2},j+\frac{1}{2}}^{n-\frac{1}{2}} + \frac{\Delta t}{\rho_{i+\frac{1}{2},j+\frac{1}{2}}}\left[ D_xT_{i+\frac{1}{2},j+\frac{1}{2}}^n + D_zZ^n_{i+\frac{1}{2},j+\frac{1}{2}}\right] \\
X_{i+\frac{1}{2},j}^{n+1}  &= X_{i+\frac{1}{2},j}^{n} + \Delta t\left[ \left(\lambda_{i+\frac{1}{2},j} + 2 \mu_{i+\frac{1}{2},j}\right)D_xU_{i+\frac{1}{2},j}^{n+\frac{1}{2}} + \lambda_{i+\frac{1}{2},j} D_zV^{n+\frac{1}{2}}_{i+\frac{1}{2},j}\right] \\
Z_{i+\frac{1}{2},j}^{n+1}  &= Z_{i+\frac{1}{2},j}^{n} + \Delta t\left[ \left(\lambda_{i+\frac{1}{2},j} + 2 \mu_{i+\frac{1}{2},j}\right)D_zV_{i+\frac{1}{2},j}^{n+\frac{1}{2}} + \lambda_{i+\frac{1}{2},j} D_xU^{n+\frac{1}{2}}_{i+\frac{1}{2},j}\right] \\
T_{i,j+\frac{1}{2}}^{n+1}  &= T_{i,j+\frac{1}{2}}^{n} + \mu_{i,j+\frac{1}{2}}\Delta t\left[ D_zU_{i,j+\frac{1}{2}}^{n+\frac{1}{2}} + D_xV^{n+\frac{1}{2}}_{i,j+\frac{1}{2}}\right] \\
\end{split}\right.
\end{equation}
where for the simplest second order differential operator $D_x A^n_{i,j} = \frac{A^n_{i+\frac{1}{2},j} - A^n_{i-\frac{1}{2},j}}{\Delta_x}$ and $D_z A^n_{i,j} = \frac{A^n_{i,j+\frac{1}{2}} - A^n_{i,j-\frac{1}{2}}}{\Delta_z}$. $n$ denotes the discrete time step, $i,j$ the $x,z$ coordinates respectively, and $\Delta t, \Delta x, \Delta z$ are the stepsizes taken into each direction respectively.

Note that in the actual implementation all arrays start at index 0. Therefore the indexes of U remain just $i,j$, but for the others we get 
\begin{equation}
\left\{
\begin{split}
U &: \  & i \rightarrow i' &,\ j \rightarrow j' \\ 
V &: \  & i +\frac{1}{2} \rightarrow i' &,\ j +\frac{1}{2} \rightarrow j' \\ 
X &: \  & i +\frac{1}{2} \rightarrow i' &,\ j \rightarrow j' \\ 
Z &: \  & i +\frac{1}{2} \rightarrow i' &,\ j \rightarrow j' \\ 
T &: \  & i \rightarrow i' &,\ j +\frac{1}{2} \rightarrow j' \\ 
\end{split}\right.
\end{equation}

where $'$ stands for the index in the code, since we imagine them displaced from the origin.

\subsection{CPML Absorbing boundaries}
In most seismic cases we have an infinite domain of our model, but we are just interested in a specific part of this domain. In order to simulate only this part without reflecting boundaries one needs to simulate "open" boundaries. This can be done by introducing an absorbing layer at the boundaries originally introduced as a Perfectly Matched Layer(PML)~\cite{Berenger1994} but later improved to a Convolutionary Perfectly Matched Layer(CPML)~\cite{Komatitsch2007} in order to reduce reflection for waves at grazing angle with the layer. 

CPML consists changing the spatial derivatives seen in the wave equations inside the layer by adding an imaginary part. 


In this section we introduce the widely used convolutional perfectly matched layer(CPML) boundary conditions~\cite{Komatitsch2007}, which are an improvement of the PML proposed 20 years earlier~\cite{Berenger1994}. This simulates having an infinite domain(which is numerically infeasible) by absorbing waves that reach the boundaries. 

\subsection{Obtaining realistic model parameters}
Modeling elastic waves requires knowledge of all three model parameters: the density $\rho$, and lamé parameters $\mu$ and $\lambda$.
Usually in literature, instead of the Lamé parameters, the S and P-wave velocities are given since these can be read more inituitively. There are simple relations between the wavespeeds and Lamé parameters following from the elastic wave equations 
\begin{equation}\label{eq:conversion_lame_to_velocity}
\{\rho, \mu, \lambda\} \rightarrow \{\rho, v_s, v_p\}, \ \text{with} \ v_s=\sqrt{\frac{\mu}{\rho}}, \ v_p = \sqrt{\frac{\lambda+2\mu}{\rho}} 
\end{equation}
\subsubsection{Brocher relations}
Usually seismic tomography and refraction studies of the earth crust report only the P-wave velocity $v_p$, while we need the density and S-wave velocity as well.
 In order to obtain realistic estimates of these parameters we can the relations derived by T. M. Brocher in 2005~\cite{Brocher2005} relating $v_p$ to $v_s$ and $v_p$ to $\rho$. These are derived by studying many real world datasets of the earth's crust giving an empirical method to obtain $\rho$ and $v_s$ given known $v_p$(in km/s)
\begin{equation}\label{eq:brochers_rho}
\rho[g/cm^3] = 1.6612v_p - 0.4721v_p^2 + 0.0671v_p^3 - 0.0043 v_p^4 + 0.000106 v_p^5
\end{equation}
and 
\begin{equation}\label{eq:brochers_vs}
v_s[km/s] = 0.7857 - 1.2344v_p + 0.7949v_p^2 - 0.1238v_p^3 + 0.0064 v_p^4
\end{equation}
which are only valid between $1.5 \ \text{km/s} < v_p < 8\   \text{km/s}$ 
\subsection{Total system energy}
In any wave equation modeling, an important check is to measure the system energy, and see that if there is no source, energy remains constant in the system.
For elastic waves the energy is given by a combination of kinetic energy $K$ of the moving particles and spring energy $T$ stored by displacing these particles from their equilibrium position following from Hooke's law.
\begin{equation}\label{eq:elastic_system_energy}
E = K + T = \frac{1}{2}\rho ||v||^2 + \frac{1}{2}\sum\tau_{ij}\epsilon_{ij}
\end{equation}


%--------------------------------------------------------------------------------------------------------------------

\section{Elastic simulation results}

\begin{itemize}
    \item elastic forward homogeneous
    \item elastic forward CPML with energies
    \item Canadian foothills with free surface boundary conditions boundaries
\end{itemize}

\section{FWI results}


%--------------------------------------------------------------------------------------------------------------------

\section{Conclusion}

%--------------------------------------------------------------------------------------------------------------------



%------------------------------------------------
%\phantomsection
%\section*{Acknowledgments} % The \section*{} command stops section numbering

%\addcontentsline{toc}{section}{Acknowledgments} % Adds this section to the table of contents

%So long and thanks for all the fish

\appendix
\section*{Appendices}
\addcontentsline{toc}{section}{Appendices}
\section{Lagrangian based derivation of the gradient via the adjoint state method}\label{sec:general_math}
In this section the adjoint equations and the gradients for a general first or second order PDE system will be derived following the approach outlined in \cite{Bradley2012}.
\subsection{General system of equations}
\label{sec:general_system}
We can write the most general minimization problem of a cost function subject any first order or second order (in time) set of partial differential equations(PDE) in the following form
\begin{equation}
\label{eq:general_system}
\begin{aligned}
\underset{m}{\text{min}} &&  \chi\left(s,m\right) = &  \int_0^T f\left(s,m\right) dt & &\\
\text{subject to} & & h\left(\ddot{s}, \dot{s}, s, m, t\right) & =  0 \\
 \text{with B.C} & & g\left((s\left(0\right), m\right) & = 0 \\
 & & k\left((\dot{s}\left(0\right), m\right) & = 0 \\
\end{aligned}
\end{equation}
where $s$ is a discretized vector of the fields and the dots denote derivatives to time, $m$ is the vector of all the discretized model parameters, $t$ denotes time, $h\left(\ddot{s}, \dot{s}, s, m, t\right)  =  0$ is the system of equations, e.g the wave equation in 2D or 3D,$T$ is the final time of integration and $g\left((s\left(0\right), m\right), k\left((\dot{s}\left(0\right), m\right)$ denote initial conditions for the field vector $s$ and its derivative $\dot{s}$. Note that this is similar to \cite{Bradley2012} but with the added explicit dependence of both $\dot s$ and $\ddot s$ giving a more general expression for the adjoint equations and the gradients. 

\subsection{Derivative to model parameters}
 When solving the minimization problem numerically, one often uses a method similar to Newton's gradient descend. This thus requires knowledge of the derivative of the cost function $\chi\left(s,m\right)$ to all of the model parameters $m$. Using the chain rule we obtain:
\begin{equation}\label{eq:derivative_of_chi}
\frac{d\chi}{dm} = \frac{\partial \chi}{\partial s}\frac{\partial s}{\partial m} + \frac{\partial \chi}{\partial m}
\end{equation}
This depends on the Frechet derivatives $\frac{\partial s}{\partial m}$ which require at least $3N$ evaluations of the forward model in order to obtain an estimate, we thus want to avoid the calculation of this term. To facilitate this we define the Lagrangian $\mathcal{L}$ by
\begin{equation}\label{eq:lagrangian}
\begin{aligned}
\mathcal{L} =   \int_0^T \left[f\left(s, m \right) + \lambda^T h\left(\ddot s, \dot s, s, m , t\right)\right] dt 
+ \mu ^T g\left((s\left(0\right), m\right)  + \eta^T k\left((\dot{s}\left(0\right), m\right)
\end{aligned}
\end{equation}
where the auxiliary variables $\lambda, \mu, \eta$ have the same length as the discretized field vector $s$.
Note that due to the initial conditions of~\cref{eq:general_system} we have $\frac{d\chi}{dm} = \frac{d\mathcal{L}}{dm}$, where using the chain rule repetitively 
\begin{equation}\label{eq:lagrangian_derivative_general}
\begin{aligned}
\frac{d\mathcal{L}}{dm} & =  \int_0^T \left[ \pder[f]{s} \pder[s]{m} + \pder[f]{m} \right. \\
& \left. + \lambda^T \left(\pder[h]{\ddot s}\pder[\ddot s]{m} + \pder[h]{\dot s} \pder[\dot s]{m} + \pder[h]{s}\pder[s]{m} + \pder[h]{m}\right) \right]dt  \\
& + \mu^T \left(\pder[g]{s(0)} \pder[s(0)]{m} + \pder[g]{m} \right) \\
& + \eta^T \left(\pder[k]{\dot s(0)} \pder[\dot s(0)]{m} + \pder[k]{m} \right)    
\end{aligned}
\end{equation}
This looks intimidating and not really much simpler, but we are still free to choose the expressions for $\lambda, \mu$ and $\eta$. We will choose this such that we can avoid calculating the computationally difficult derivatives $\pder[s]{m}$. But first we need to do some partial integration to get rid of  $\pder[\dot s]{m}$ and $\pder[\ddot s]{m}$.
With a single partial integration we can write
\begin{equation}\label{eq:lagrangian_partial_first_order}
\begin{aligned}
\int^T_0  \lambda^T \pder[h]{\dot s} \pder[\dot s]{m} = \left[\lambda^T \pder[h]{\dot s} \pder[s]{m}\right]^T_0
 - \int_0^T \pder[s]{m}\left(\dot \lambda^T \pder[h]{\dot s} + \lambda^T \pder{t}\pder[h]{\dot s} \right)
\end{aligned}
\end{equation}
and with a double partial integration we can write
\begin{equation}\label{eq:lagrangian_partial_second_order}
\begin{aligned}
\int^T_0  \lambda^T \pder[h]{\ddot s} \pder[\ddot s]{m} &= \left[\lambda^T \pder[h]{\dot s} \pder[\dot s]{m} - \pder[s]{m}\left(\dot \lambda^T \pder[h]{\ddot s} + \lambda^T \pder{t}\pder[h]{\ddot s}\right)  \right]^T_0 \\
 &+ \int_0^T \pder[s]{m}\left(\ddot \lambda^T \pder[h]{\ddot s} + 2 \dot \lambda^T \pder{t}\pder[h]{\ddot s} + \lambda^T \ppder{t}\pder[h]{\ddot s} \right) dt 
\end{aligned}
\end{equation}
So filling this back into~\cref{eq:lagrangian_derivative_general} and regrouping terms gives
\begin{equation}
\begin{aligned}
\frac{d\mathcal{L}}{dm}& = \int_0^T \left[\pder[s]{m}\left( \pder[f]{s} + \ddot \lambda^T \pder[h]{\ddot s}
 + \dot \lambda^T\left(2\pder{t}\pder[h]{\ddot s}- \pder[h]{\dot s}\right)\right.\right. \\
& \left. \left.  + \lambda^T\left(\pder[h]{s} + \ppder{t}\pder[h]{\ddot s} -\pder{t}\pder[h]{\dot s}\right)\right)
 + \pder[f]{m} + \lambda^T \pder[h]{m}\right]dt \\
 &+\left.\left(\mu^T \pder[g]{s(0)} - \lambda^T\pder[h]{\dot s} + \dot \lambda^T \pder[h]{\ddot s} + \lambda^T\pder{t}\pder[h]{\ddot s}\right)\pder[s]{m}\right|_0 \\
 &+ \left. \left(\eta^T\pder[h]{\dot s(0)} - \lambda^T \pder[h]{\ddot s}\right)\pder[\dot s]{m}\right|_0 \\
 & + \left.\lambda^T \pder[h]{\ddot s} \pder[\dot s]{m}\right|_T + \left.\left(\lambda^T \pder[h]{\dot s} - \dot \lambda^T \pder[h]{\ddot s} - \lambda^T \pder{t}\pder[h]{\ddot s} \right)\pder[s]{m}\right|_T\\
 & + \mu^T \pder[g]{m} + \eta^T \pder[k]{m}
\end{aligned}
\end{equation}
we can then choose values for the auxiliary variables such that undesired terms drop out of $\frac{d\mathcal{L}}{dm}$. If we set 
\begin{equation}
\begin{aligned}
\mu^T &= \left(\dot \lambda(0) \pder[h]{\ddot s} + \lambda^T(0)\left(\pder{t} \pder[h]{\ddot s} - \pder[h]{\dot s} \right)\right) \left(\pder[g]{s(0)}\right)^{-1} \\
\eta^T &= \left(\lambda(0) \pder[h]{\ddot s} \right)\left(\pder[k]{\dot s(0)}\right)^{-1}\\
\lambda(T) & = 0\\
\dot \lambda(T) &= 0
\end{aligned}
\end{equation}
and let $\lambda$ satisfy the following so called \emph{adjoint} equation 
\begin{equation}
\label{eq:general_adjoint}
\begin{aligned}
\ddot \lambda^T \pder[h]{\ddot s} + \dot \lambda^T \left(2\pder{t}\pder[h]{\ddot s} - \pder[h]{\dot s} \right)
 + \lambda^T\left(\pder[h]{s} + \ppder{t}\pder[h]{\ddot s} -\pder{t}\pder[h]{\dot s}\right) = -\pder[f]{s}
\end{aligned}
\end{equation}
we can see that the $\pder[s]{m}$ terms drop out of $\frac{d\mathcal{L}}{m}$ and we remain for the \emph{gradients} only with
\begin{equation}\label{eq:general_gradient}
\frac{d\mathcal{L}}{dm} =\int_0^T \pder[f]{m} + \lambda^T \pder[h]{m} dt + \mu^T \pder[g]{m} + \eta^T \pder[k]{m}
\end{equation} 
where the two rightmost terms are zero if the initial conditions do not depend directly on the model parameters $m$. \cref{eq:general_adjoint} is called the \emph{adjoint} equation to the original system of equations $h\left(\ddot s, \dot s, s, m, t\right)$

\section{More example applications}\label{sec:examples}

\subsection{The second order electromagnetic wave equation}
Now for an example with second order terms as well we take the following second order electromagnetic wave equation 
\begin{equation}
\epsilon \ppder[E_y]{t} = \pder{x}\left(\frac{1}{\mu}\pder[E_y]{x}\right) + \pder{z}\left(\frac{1}{\mu} \pder[E_y]{z}\right) - \sigma \pder[E_y]{t} 
\end{equation}
which models the same as~\cref{exmp:electromagnetic_system}. We can see that now $s = \vec{E_y}$ a single field variable ( which is still a vector of length N) 
\begin{equation}
T(m) = \epsilon, \ C(m) = -\sigma, \ A(m) = \mathcal{D}_x\frac{1}{\mu}\mathcal{D}_x + \mathcal{D}_z \frac{1}{\mu} \mathcal{D}_z
\end{equation}
All of these operators are self-adjoint, thus $A^T(m) = A(m), \ C^T(m) = C(m), \ T^T(m) = T(m) $, we thus get for the adjoint equation
\begin{equation}
\epsilon \ppder[\lambda]{t} = \pder{x}\left(\frac{1}{\mu}\pder[\lambda]{x}\right) + \pder{z}\left(\frac{1}{\mu} \pder[\lambda]{z}\right) + \sigma \pder[\lambda]{t} 
\end{equation}
where there is only a sign change in front of $\sigma$ due to~\cref{eq:adjoint_discretised_linear}. 
The gradients then become according to~\cref{eq:gradient_discretised_linear}
\begin{equation}
\begin{aligned}
\frac{d\chi}{d\epsilon} &= \int_0^T\vec{\lambda}^T\vec{\ddot{E_y}} \ dt \\
\frac{d\chi}{d\mu} &= \int_0^T\vec{\lambda}^T\left(\pder{x}\left(\frac{1}{\mu^2}\pder[\vec{E_y}]{x}\right) + \pder{z}\left(\frac{1}{\mu^2} \pder[\vec{E_y}]{z}\right)\right)\ dt \\
\frac{d\chi}{d\sigma}& = \int_0^T\vec{\lambda}^T\vec{\dot{E_y}} \  dt
\end{aligned}
\end{equation}

\subsection{The second order acoustic wave equation}
The acoustic wave equation with variable density $\rho$ and velocity $c$ is given by
\begin{equation}\label{eq:second_order_acoustic}
\frac{1}{\rho c^2}\ppder[p]{t} = \left(\pder{x}\left(\frac{1}{\rho}\pder[p]{x}\right) + \pder{z}\left(\frac{1}{\rho}\pder[p]{z}\right) \right)
\end{equation}
we thus get 
\begin{equation}
T(m) = \frac{1}{\rho c^2}, \ C(m) = 0, \ A(m) = \mathcal{D}_x\frac{1}{\rho}\mathcal{D}_x + \mathcal{D}_z \frac{1}{\rho} \mathcal{D}_z
\end{equation}
which looks very similar to the electromagnetic case, again $A^T(m) = A(m), \ C^T(m) = C(m), \ T^T(m) = T(m) $, so following~\cref{eq:adjoint_discretised_linear} the adjoint equation is the same as the original equation
\begin{equation}
\frac{1}{\rho c^2}\ppder[\lambda]{t} = \left(\pder{x}\left(\frac{1}{\rho}\pder[\lambda]{x}\right) + \pder{z}\left(\frac{1}{\rho}\pder[\lambda]{z}\right) \right)
\end{equation}
According to~\cref{eq:gradient_discretised_linear} we then obtain
\begin{equation}
\begin{aligned}
\frac{d\chi}{dc} &=-\frac{2}{\rho c^3} \int_0^T\vec{\lambda}^T\vec{\ddot{p}} \ dt \\
\frac{d\chi}{d\rho} &= \int_0^T\vec{\lambda}^T\left(-\frac{1}{\rho^2 c^2} \vec{\ddot{p}} + \pder{x}\left(\frac{1}{\rho^2}\pder[\vec{p}]{x}\right) + \pder{z}\left(\frac{1}{\rho^2} \pder[\vec{p}]{z}\right)\right)\ dt \\
\end{aligned}
\end{equation}


\subsection{The first order acoustic wave equation}
The first order acoustic wave equation with variable density $\rho$ and velocity $c$ is given by
\begin{equation}
\label{eq:acoustic_first_order_wave_equation}
\begin{aligned}
\frac{1}{\rho c^2}\pder[p]{t} & = -\pder[v_x]{x} - \pder[v_z]{z} \\
 \pder[v_x]{t} & =-\frac{1}{\rho} \pder[p]{x} \\
 \pder[v_z]{t} & =-\frac{1}{\rho} \pder[p]{z} \\
\end{aligned}
\end{equation}
this gives 
\begin{equation}
T(m) = 0, \ C(m) = -
\begin{bmatrix}
\frac{1}{\rho c^2} &0& 0 \\
0&1&0\\
0&0&1\\
\end{bmatrix},
\ A(m) = \begin{bmatrix}
0 &-\mathcal{D}_x& -\mathcal{D}_z \\
-\frac{1}{\rho}\mathcal{D}_x&0&0\\
-\frac{1}{\rho}\mathcal{D}_z&0&0\\
\end{bmatrix}
\end{equation}
we thus get $C^T(m) = C$ and
\begin{equation}
\ A^T(m) = \begin{bmatrix}
0 &\mathcal{D}_x\frac{1}{\rho}& \mathcal{D}_z\frac{1}{\rho} \\
\mathcal{D}_x&0&0\\
\mathcal{D}_z&0&0\\
\end{bmatrix}
\end{equation}
so the adjoint equations according to~\cref{eq:adjoint_discretised_linear} become
\begin{equation}\label{eq:adjoint_acoustic_first_order}
\begin{aligned}
\frac{1}{\rho c^2}\pder[\lambda_1]{t} & = -\pder[\left(\frac{1}{\rho}\lambda_2\right)]{x} - \pder[\left(\frac{1}{\rho}\lambda_3\right)]{z} \\
 \pder[\lambda_2]{t} & =- \pder[\lambda_1]{x} \\
 \pder[\lambda_3]{t} & =-\pder[\lambda_1]{z} \\
\end{aligned}
\end{equation}

and the gradients according to~\cref{eq:gradient_discretised_linear}
\begin{equation}
\begin{aligned}
\frac{d\chi}{dc} &=-\frac{2}{\rho c^3} \int_0^T\vec{\lambda_1}^T\vec{\dot{p}} \ dt \\
\frac{d\chi}{d\rho} &= \int_0^T \frac{-1}{\rho^2 c^2} \vec{\lambda_1}^T \vec{\dot{p}} - \frac{1}{\rho^2}\left(\vec{\lambda_2}^T \pder[\vec{p}]{x} + \vec{\lambda_3}^T \pder[\vec{p}]{z}\right)\  dt\\
\end{aligned}
\end{equation}

%----------------------------------------------------------------------------------------
%	REFERENCE LIST
%----------------------------------------------------------------------------------------
\phantomsection
\bibliographystyle{unsrt}
\bibliography{bib/UIS_ICP}


%----------------------------------------------------------------------------------------

\end{document}